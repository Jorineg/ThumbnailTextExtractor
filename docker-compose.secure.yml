# Secure ThumbnailTextExtractor Architecture
#
# Security model:
# - Processor runs in fresh air-gapped container per job (network_mode: none)
# - Only trusted components (fetcher, uploader) have network/credentials
# - Orchestrator spawns containers, has no credentials
# - QCAD also air-gapped, communicates via shared volume
#
# Data flow:
# Fetcher (network) -> INPUT_QUEUE -> Orchestrator -> PROCESSOR (air-gapped) -> OUTPUT_QUEUE -> Uploader (network)

services:
  # TRUSTED: Downloads files from S3, claims jobs from DB
  # Uses minimal DB role (tte_fetcher) that can ONLY call claim_pending_file_content
  fetcher:
    build:
      context: .
      dockerfile: Dockerfile.trusted
    container_name: tte-fetcher
    restart: unless-stopped
    environment:
      # DB: Minimal role (can ONLY claim pending files)
      - TTE_FETCHER_DB_DSN=${TTE_FETCHER_DB_DSN}
      # S3: For downloading files (TODO: replace with minimal S3 credentials)
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - STORAGE_BUCKET=${STORAGE_BUCKET:-files}
      - POLL_INTERVAL=${POLL_INTERVAL:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - BETTERSTACK_SOURCE_TOKEN=${BETTERSTACK_SOURCE_TOKEN:-}
      - BETTERSTACK_INGEST_HOST=${BETTERSTACK_INGEST_HOST:-}
      - MAX_RETRIES=${MAX_RETRIES:-3}
    volumes:
      - tte-queue-input:/queue/input
      - tte-queue-status:/queue/status
      - ./logs:/app/logs
    networks:
      - external
      - supabase_default  # For DB/S3 access via DNS
    command: python -m src.fetcher

  # TRUSTED: Spawns fresh processor containers per job
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.trusted
    container_name: tte-orchestrator
    restart: unless-stopped
    environment:
      - PROCESSOR_IMAGE=tte-processor:latest
      - PROCESSOR_RUNTIME=${PROCESSOR_RUNTIME:-runsc}
      - PROCESSOR_TIMEOUT=${PROCESSOR_TIMEOUT:-600}
      - PROCESSOR_MEMORY=${PROCESSOR_MEMORY:-2g}
      - PROCESSOR_CPUS=${PROCESSOR_CPUS:-2}
      - QCAD_IMAGE=${QCAD_IMAGE:-arjankalfsbeek/qcad:latest}
      - QCAD_EPHEMERAL=${QCAD_EPHEMERAL:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Docker volume names - these are the ACTUAL names used by Docker
      # (using external volumes to avoid compose project name prefix)
      - INPUT_VOLUME=tte-queue-input
      - OUTPUT_VOLUME=tte-queue-output
      - STATUS_VOLUME=tte-queue-status
      - DWG_EXCHANGE_VOLUME=tte-dwg-exchange
    volumes:
      - tte-queue-input:/queue/input
      - tte-queue-output:/queue/output
      - tte-queue-status:/queue/status
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - internal
    command: python -m src.orchestrator
    depends_on:
      - processor-build

  # TRUSTED: Sanitizes and uploads results
  # Uses minimal DB role (tte_uploader) that can ONLY update specific columns
  uploader:
    build:
      context: .
      dockerfile: Dockerfile.trusted
    container_name: tte-uploader
    restart: unless-stopped
    environment:
      # DB: Minimal role (can ONLY update processing results)
      - TTE_UPLOADER_DB_DSN=${TTE_UPLOADER_DB_DSN}
      # S3: For uploading thumbnails (TODO: replace with minimal S3 credentials)
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - THUMBNAIL_BUCKET=${THUMBNAIL_BUCKET:-thumbnails}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - BETTERSTACK_SOURCE_TOKEN=${BETTERSTACK_SOURCE_TOKEN:-}
      - BETTERSTACK_INGEST_HOST=${BETTERSTACK_INGEST_HOST:-}
    volumes:
      - tte-queue-input:/queue/input:ro
      - tte-queue-output:/queue/output
      - tte-queue-status:/queue/status
      - ./logs:/app/logs
    networks:
      - external
      - supabase_default  # For DB/S3 access via DNS
    command: python -m src.uploader

  # Build-only service: creates the processor image
  processor-build:
    build:
      context: .
      dockerfile: Dockerfile.processor
    image: tte-processor:latest
    container_name: tte-processor-build
    entrypoint: ["echo", "Processor image built"]
    restart: "no"

  # UNTRUSTED (air-gapped): DWG/DXF conversion via QCAD
  # NOTE: With QCAD_EPHEMERAL=true (default), this container is NOT used.
  # Orchestrator spawns fresh QCAD containers per DWG job instead.
  # Set QCAD_EPHEMERAL=false to use this persistent container (less secure).
  qcad:
    image: arjankalfsbeek/qcad:latest
    container_name: tte-qcad
    profiles: ["persistent-qcad"]  # Only starts with: docker compose --profile persistent-qcad up
    restart: unless-stopped
    network_mode: none
    read_only: true
    tmpfs:
      - /tmp:size=512m,mode=1777
    volumes:
      - tte-dwg-exchange:/dwg-exchange
      - ./src/qcad_watcher.sh:/watcher.sh:ro
    entrypoint: ["/bin/sh", "/watcher.sh"]

# External volumes with explicit names (no compose project prefix)
# These must be created before starting: docker volume create tte-queue-input etc.
# Or use: docker compose up (compose will create them automatically as external: false)
volumes:
  tte-queue-input:
    name: tte-queue-input
  tte-queue-output:
    name: tte-queue-output
  tte-queue-status:
    name: tte-queue-status
  tte-dwg-exchange:
    name: tte-dwg-exchange

networks:
  external:
    driver: bridge
  internal:
    driver: bridge
    internal: true
  supabase_default:
    external: true  # Assumes supabase network already exists
